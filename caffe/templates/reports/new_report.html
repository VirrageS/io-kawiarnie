{% extends "home/base.html" %}
{% load tags %}

{% block title %}
Nowy raport
{% endblock %}

{% block content %}
<script type="text/javascript">
(function ($) {
  "use strict"

  var products;
  var categories;

  function getProduct(product) {
    var product;

    for (var i = 0; i < products.length; ++i) {
      if (products[i].id == product) {
        product = products[i];
      }
    }

    return product;
  }

  function getCategoryOrCreate(category) {
    var foundCategory;

    for (var i = 0; i < categories.length; ++i) {
      if (categories[i].id == category.id) {
        foundCategory = categories[i];
      }
    }

    if (!foundCategory) {
      $('.categories').append('\
        <div id="' + category.id + '" class="category">\
          <div class="category-name">\
            ' + category.name + '\
          </div>\
          <div class="products"></div>\
        </div>\
      ');

      categories.push(category);
      foundCategory = category;
    }

    return $('#' + foundCategory.id + '.category');
  }

  function addProductToSelect(product) {
    $('select').append('\
      <option id="' + product.id + '" value="' + product.id + '">' + product.name + '</option>\
    ');
  }


  $(document).ready(function() {
    products = {{ products|safe }};
    categories = [];

    $('select').on('change', function(event, obj) {
      var product = getProduct(this.value);
      if (product) {
        // remove product from selected
        $(this).find(":selected").remove();

        var errorClasses = '', amount = '', errors = '';

        if (product.selected) {
          amount = product.amount;

          if (product.errors) {
            // add error if error occured
            errors = '<ul class="errorlist">';
            for (var i = 0; i < product.errors.length; ++i) {
              errors += '<li>' + product.errors[i] + '</li>';
            }
            errors += '</ul>';

            // change input border color if error occured
            errorClasses = 'error';
          }

          product.selected = false;
        }

        var categoryProducts = getCategoryOrCreate(product.category).find('.products');

        categoryProducts.append('\
          <div id="' + product.id + '" class="product">\
            <input type="hidden" name="' + product.id + '" value="' + product.id + '"/>\
            <div class="name">\
              ' + product.name +'\
            </div>\
            <div class="amount">\
              <input type="number" name="' + product.id + '" value="' + amount + '" class="' + errorClasses + '"/>\
            </div>\
            <div class="unit">\
              ' + product.unit + '\
            </div>\
            <div class="trash">\
              <i class="fa fa-trash-o" aria-hidden="true"></i>\
            </div>\
          </div>\
        ');

        categoryProducts.append(errors);
      }
    });

    for (var i = 0; i < products.length; ++i) {
      addProductToSelect(products[i]);

      if (products[i].selected) {
        $('select').find('#' + products[i].id).parent().val(products[i].id).trigger('change');
      }
    }

    $(document).on('click', '.trash', function() {
      var product = $(this).closest('.product');

      var p = getProduct(product.attr('id'));
      if (p) {
        addProductToSelect(p);

        var category = product.closest('.category');
        var errors = $(product).next('ul');

        if (errors) {
          errors.remove(); // remove error
        }
        product.remove();

        if (!$.trim(category.find('.products').html())) {
          for (var i = 0; i < categories.length; ++i) {
            if (categories[i].id == category.attr('id')) {
              categories.splice(i, 1);
            }
          }

          category.remove();
        }
      }
    });
  });
})(jQuery);
</script>

<form method="POST" class="report-form">
  {% csrf_token %}

  <div class="input-line select-wrapper">
    <select>
      <option name="product" id="-1" value="-1">-------------</option>
    </select>
    <label for="">Wybierz produkt</label>
  </div>

  <div class="categories"></div>

  <button type="submit" class="button button-rounded button-green">Dodaj</button>
</form>
{% endblock %}
